<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>النظام الإداري الشامل</title>
    <!-- خط القاهرة من Google Fonts لدعم اللغة العربية بشكل جميل -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* أنماط CSS مخصصة لتصميم مزخرف ومتجاوب */
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f4f7f6; /* لون خلفية فاتح افتراضي */
            background-image: none; /* لا توجد صورة خلفية افتراضيًا */
            background-size: auto;
            background-repeat: repeat;
            background-position: center center;
            margin: 0;
            padding: 0; /* إزالة الحشو من الجسم ليتم التحكم به بواسطة الكونتينر */
            color: #333;
            direction: rtl; /* تحديد اتجاه النص من اليمين لليسار */
            line-height: 1.6;
            transition: background-color 0.3s ease, background-image 0.3s ease; /* تأثيرات انتقالية للخلفية */
        }
        /* New Header Styles */
        .app-header {
            background-color: #2c3e50; /* Dark blue/grey */
            color: white;
            padding: 15px 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; /* Makes header sticky */
            top: 0;
            z-index: 1000; /* Ensures it stays on top */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            transition: background-color 0.3s ease; /* Transition for header color */
        }

        .app-title {
            margin: 0;
            font-size: 2em;
            font-weight: 700;
            text-align: right; /* Align right for RTL */
            flex-grow: 1; /* Allow title to take available space */
        }

        /* Dropdown styles */
        .dropdown {
            position: relative;
            display: inline-block;
            margin-right: 20px; /* Space from title */
        }

        .dropbtn {
            background-color: #3498db; /* Blue */
            color: white;
            padding: 12px 25px;
            font-size: 18px;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dropbtn:hover {
            background-color: #2980b9;
        }

        .arrow-down {
            border: solid white;
            border-width: 0 3px 3px 0;
            display: inline-block;
            padding: 3px;
            transform: rotate(45deg);
            -webkit-transform: rotate(45deg);
        }
        /* Dropdown for sub-menus */
        .dropdown-submenu {
            position: relative;
        }

        .dropdown-item-with-arrow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            color: black;
            text-decoration: none;
            display: block;
            transition: background-color 0.2s ease;
        }
        .dropdown-item-with-arrow:hover {
            background-color: #f1f1f1;
        }

        .arrow-left {
            border: solid black;
            border-width: 0 3px 3px 0;
            display: inline-block;
            padding: 3px;
            transform: rotate(135deg); /* Point left for RTL */
            -webkit-transform: rotate(135deg);
        }

        .dropdown-content-submenu {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
            right: 100%; /* Position to the left of the parent item in RTL */
            top: 0;
            text-align: right;
        }

        .dropdown-submenu:hover .dropdown-content-submenu {
            display: block;
        }


        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 220px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
            right: 0; /* Align dropdown to the right for RTL */
            text-align: right;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.2s ease;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); /* ظل خفيف للكونتينر */
            padding: 30px;
            overflow: hidden;
            display: grid;
            grid-template-columns: 1fr; /* عمود واحد افتراضيًا */
            gap: 30px; /* تباعد بين الأقسام */
            transition: background-color 0.3s ease; /* Transition for container color */
        }
        h1, h2 {
            color: #2c3e50; /* لون عنوان غامق */
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            padding-bottom: 10px;
        }
        h1::after, h2::after {
            content: '';
            width: 80px;
            height: 4px;
            background-color: #3498db; /* خط أزرق تحت العناوين */
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px;
        }
        .card {
            background-color: #ecf0f1; /* لون خلفية فاتح للبطاقات */
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* ظل للبطاقات */
            margin-bottom: 20px;
            transition: background-color 0.3s ease; /* Transition for card color */
        }
        .form-group {
            margin-bottom: 18px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea,
        select,
        input[type="color"] { /* إضافة نمط لمدخل اللون */
            width: calc(100% - 22px); /* ضبط العرض ليشمل الحشو والحدود */
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease; /* تأثير عند التركيز */
            box-sizing: border-box; /* لضمان أن العرض يشمل الحشو والحدود */
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus,
        input[type="color"]:focus { /* إضافة نمط لمدخل اللون */
            border-color: #3498db; /* لون الحدود عند التركيز */
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5); /* ظل عند التركيز */
        }
        textarea {
            resize: vertical; /* السماح بتغيير حجم النص عموديًا */
            min-height: 80px;
        }
        button {
            background-color: #2ecc71; /* لون زر أخضر */
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease; /* تأثيرات عند التحويم */
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #27ae60; /* لون أغمق عند التحويم */
            transform: translateY(-2px); /* رفع بسيط عند التحويم */
        }
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap; /* للسماح للأزرار بالانتقال لسطر جديد في الشاشات الصغيرة */
        }
        .tab-button {
            background-color: #bdc3c7; /* لون زر التبويبات الرمادي */
            color: #333;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 8px 10px; /* تباعد بين الأزرار */
            transition: background-color 0.3s ease;
        }
        .tab-button.active {
            background-color: #3498db; /* لون زر التبويبات النشط */
            color: white;
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        .tab-button:hover:not(.active) {
            background-color: #95a5a6;
        }
        .tab-content {
            display: none; /* إخفاء محتوى التبويبات افتراضيًا */
        }
        .tab-content.active {
            display: block; /* إظهار محتوى التبويب النشط */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #34495e; /* لون رأس الجدول */
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f8f8f8; /* لون للصفوف الزوجية */
        }
        tr:hover {
            background-color: #f1f1f1; /* لون عند التحويم على الصفوف */
        }
        .message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            display: none; /* إخفاء الرسائل افتراضيًا */
        }
        .message.success {
            background-color: #d4edda; /* لون أخضر فاتح للنجاح */
            color: #155724; /* لون نص أخضر داكن */
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da; /* لون أحمر فاتح للخطأ */
            color: #721c24; /* لون نص أحمر داكن */
            border: 1px solid #f5c6cb;
        }
        /* أنماط خاصة بقسم يوميات الصندوق والجرد لعرضها في شبكة */
        #cashJournal .card:first-of-type,
        #inventory .card:first-of-type {
            grid-column: span 1; /* كل بطاقة تأخذ عمودًا واحدًا */
        }
        .daily-journal-section {
            grid-column: 1 / -1; /* لجعل الجدول والملخص يمتدان على جميع الأعمدة */
        }
        /* أنماط خاصة بقسم الملخص */
        .summary-card {
            background-color: #e8f5e9; /* أخضر فاتح */
            border-left: 5px solid #4caf50; /* حدود خضراء سميكة */
            padding: 20px;
            border-radius: 10px;
        }
        .summary-card p {
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #388e3c; /* أخضر داكن للنص */
        }
        .summary-card p strong {
            color: #2e7d32; /* أخضر أغمق للأرقام */
        }
        .calculated-value {
            color: #007bff; /* لون أزرق للقيم المحسوبة */
            font-weight: bold;
        }
        /* تعديلات متجاوبة للشاشات الصغيرة */
        @media (min-width: 768px) {
            .container {
                grid-template-columns: repeat(2, 1fr); /* عمودين للشاشات الأكبر */
            }
            #cashJournal .card:first-of-type,
            #inventory .card:first-of-type {
                grid-column: span 1;
            }
        }
        @media (max-width: 767px) {
            .container {
                padding: 15px;
            }
            .tab-buttons {
                flex-direction: column; /* الأزرار عمودية في الشاشات الصغيرة */
            }
            .tab-button {
                margin: 0 0 10px 0;
                width: 100%;
            }
            th, td {
                font-size: 0.85em;
                padding: 8px;
            }
        }

        /* أنماط الطباعة - ما يظهر عند الطباعة */
        @media print {
            body {
                background-color: #fff; /* خلفية بيضاء للطباعة */
                margin: 0;
                padding: 0;
                background-image: none !important; /* إزالة صورة الخلفية عند الطباعة */
            }
            .container {
                box-shadow: none; /* إزالة الظلال */
                border-radius: 0; /* إزالة الحدود الدائرية */
                padding: 0;
                margin: 0;
                display: block; /* تغيير عرض الشبكة إلى عرض عادي */
                width: 100%;
                max-width: none;
            }
            h1, h2 {
                color: #000; /* لون أسود للعناوين */
                text-align: center;
                margin-bottom: 15px;
                padding-bottom: 5px;
            }
            h1::after, h2::after {
                display: none; /* إخفاء الخطوط تحت العناوين */
            }

            /* Ensure tables and their content are visible */
            table {
                box-shadow: none;
                border: 1px solid #ccc; /* إضافة حدود للجدول المطبوع */
                font-size: 12px; /* تصغير حجم الخط للطباعة */
            }
            th, td {
                border: 1px solid #ddd; /* حدود للخلايا */
                padding: 8px 10px;
                background-color: #fff; /* خلفية بيضاء للخلايا */
            }
            th {
                background-color: #eee !important; /* خلفية فاتحة لرؤوس الأعمدة */
                color: #000 !important;
            }
            tr:nth-child(even) {
                background-color: #f8f8f8 !important;
            }
            .print-button { /* إخفاء زر الطباعة نفسه عند الطباعة */
                display: none !important;
            }
            /* إظهار ملخص الصندوق في الطباعة إذا كان في الصفحة الرئيسية */
            #mainPage .summary-card {
                display: block !important;
            }
        }
        /* أنماط أزرار التعديل والحذف */
        .action-buttons button {
            width: auto;
            padding: 8px 12px;
            font-size: 14px;
            margin: 5px 2px;
            border-radius: 5px;
            display: inline-block;
        }
        .action-buttons .edit-btn {
            background-color: #3498db; /* أزرق */
        }
        .action-buttons .edit-btn:hover {
            background-color: #2980b9;
        }
        .action-buttons .delete-btn {
            background-color: #e74c3c; /* أحمر */
        }
        .action-buttons .delete-btn:hover {
            background-color: #c0392b;
        }
        /* زر تحديث/إضافة القيد */
        #cashJournalForm button[type="submit"],
        #inventoryForm button[type="submit"] {
            background-color: #2ecc71; /* أخضر للإضافة */
        }
        #cashJournalForm button[type="submit"].update-mode,
        #inventoryForm button[type="submit"].update-mode {
            background-color: #f39c12; /* برتقالي للتحديث */
        }
        #cashJournalForm button[type="submit"].update-mode:hover,
        #inventoryForm button[type="submit"].update-mode:hover {
            background-color: #e67e22;
        }
        /* أنماط خاصة لقسم إدارة أرصدة الصندوق */
        .balance-management-card {
            background-color: #e0f2f7; /* لون أزرق فاتح */
            border-left: 5px solid #03a9f4; /* حدود زرقاء */
            margin-top: 30px;
        }
        .balance-management-card .form-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .balance-management-card .form-group label {
            flex: 1;
            margin-bottom: 0;
            font-weight: normal;
        }
        .balance-management-card .form-group input {
            flex: 2;
            width: auto;
        }
        .balance-summary {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
        }
        .balance-summary p {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 1.05em;
        }
        .balance-summary p strong {
            color: #2c3e50;
        }
        .balance-summary .discrepancy {
            font-weight: bold;
        }
        .balance-summary .discrepancy.positive {
            color: #27ae60; /* أخضر للفرق الإيجابي */
        }
        .balance-summary .discrepancy.negative {
            color: #e74c3c; /* أحمر للفرق السلبي */
        }
        .balance-summary .discrepancy.zero {
            color: #3498db; /* أزرق للفرق صفر */
        }
        /* أنماط أزرار الإضافة من التقارير */
        .add-from-report-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .add-from-report-buttons button {
            background-color: #1abc9c; /* لون تركواز */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            width: auto;
            flex-grow: 1;
            max-width: 250px;
        }
        .add-from-report-buttons button:hover {
            background-color: #16a085;
        }
        /* زر الرجوع */
        .back-button {
            background-color: #95a5a6; /* رمادي فاتح */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            display: block; /* لجعل الزر يأخذ سطرًا كاملاً */
            width: fit-content; /* ليأخذ عرض المحتوى فقط */
            margin-right: auto; /* لجعله في أقصى اليمين في RTL */
            transition: background-color 0.3s ease;
        }
        .back-button:hover {
            background-color: #7f8c8d; /* رمادي أغمق عند التحويم */
        }

        /* Page Section Management */
        .page-section {
            display: none; /* Hide all major sections by default */
        }

        .page-section.active {
            display: block; /* Show active major section */
        }

        /* Main Page Content Styles */
        #mainPage {
            text-align: center;
            padding: 50px 20px;
        }

        #mainPage img {
            max-width: 80%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            margin-bottom: 30px;
        }

        #mainPage h2 {
            font-size: 2.5em;
            color: #34495e;
            margin-bottom: 20px;
        }

        #mainPage p {
            font-size: 1.2em;
            color: #555;
            max-width: 800px;
            margin: 0 auto;
        }


        /* Media queries for responsiveness */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                align-items: flex-end; /* Align header items to the right in column layout */
                padding: 15px;
            }
            .app-title {
                text-align: center;
                width: 100%;
                margin-bottom: 15px;
            }
            .dropdown {
                margin-right: 0;
                width: 100%;
                text-align: center;
            }
            .dropbtn {
                width: 100%;
                justify-content: center;
            }
            .dropdown-content {
                min-width: unset;
                width: 100%;
                right: 0;
                left: 0;
            }
            .dropdown-content-submenu {
                right: auto; /* Reset right positioning */
                left: 100%; /* Position to the right of parent in small screens */
                top: 0;
            }
            #mainPage img {
                max-width: 95%;
            }
            #mainPage h2 {
                font-size: 2em;
            }
            #mainPage p {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <h1 class="app-title">النظام الإداري الشامل</h1>
            <nav class="main-nav">
                <div class="dropdown">
                    <button class="dropbtn">القائمة الرئيسية <span class="arrow-down"></span></button>
                    <div class="dropdown-content">
                        <a href="#" onclick="showPage('mainPage'); return false;">الصفحة الرئيسية</a>
                        <a href="#" onclick="showMessage('generalMessage', 'info', 'إدارة المخازن تحت الإنشاء.'); return false;">إدارة المخازن</a>
                        <a href="#" onclick="showMessage('generalMessage', 'info', 'إدارة المشتريات تحت الإنشاء.'); return false;">إدارة المشتريات</a>
                        <div class="dropdown-submenu">
                            <a href="#" class="dropdown-item-with-arrow">إدارة المبيعات <span class="arrow-left"></span></a>
                            <div class="dropdown-content-submenu">
                                <a href="#" onclick="showPage('salesCashier'); return false;">واجهة الكاشير</a>
                                <a href="#" onclick="showMessage('generalMessage', 'info', 'تقارير المبيعات تحت الإنشاء.'); return false;">تقارير المبيعات</a>
                            </div>
                        </div>
                        <a href="#" onclick="showPage('cashJournalAppContainer'); showTab('cashJournal'); return false;">يوميات الصندوق/الجرد/التقارير</a>
                        <a href="#" onclick="showPage('branchManagement'); return false;">إدارة الفروع</a> <!-- رابط جديد لإدارة الفروع -->
                        <a href="#" onclick="showPage('appearanceSettings'); return false;">إعدادات المظهر</a> <!-- رابط جديد -->
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <div class="container">
        <div id="generalMessage" class="message"></div> <!-- رسائل عامة للتطبيق -->

        <!-- Main Page Section -->
        <div id="mainPage" class="page-section active">
            <h2>مرحباً بك في النظام الإداري الشامل</h2>
            <img src="https://placehold.co/600x400/AED6F1/2E86C1?text=نظام+إداري" alt="صورة للنظام الإداري">
            <p>هذا النظام يساعدك في إدارة يوميات الصندوق والجرد اليومي بكفاءة وفعالية. استخدم القائمة الرئيسية للتنقل بين الأقسام المختلفة.</p>

            <div class="card summary-card" style="margin-top: 40px;">
                <h2>ملخص الصندوق اليومي (إجمالي الحركات لجميع الفروع)</h2>
                <p>إجمالي الإيرادات النقدية: <strong id="mainPageTotalCashIn">0.00</strong></p>
                <p>إجمالي المصروفات النقدية: <strong id="mainPageTotalCashOut">0.00</strong></p>
                <p>إجمالي إيرادات الشبكة/الشيكات: <strong id="mainPageTotalNetworkIn">0.00</strong></p>
                <p>إجمالي مصروفات الشبكة/الشيكات: <strong id="mainPageTotalNetworkOut">0.00</strong></p>
                <p>صافي رصيد الصندوق النقدي: <strong id="mainPageNetCashBalance">0.00</strong></p>
            </div>
        </div>

        <!-- Sales Cashier Interface Section -->
        <div id="salesCashier" class="page-section">
            <button class="back-button" onclick="showPage('mainPage')">العودة إلى الصفحة الرئيسية</button>
            <div class="card">
                <h2>واجهة الكاشير للمبيعات</h2>
                <div id="salesMessage" class="message"></div>

                <div class="form-group">
                    <label for="sale_item_name">اسم الصنف:</label>
                    <input type="text" id="sale_item_name" placeholder="مثال: قميص رجالي، عطر" required>
                </div>
                <div class="form-group">
                    <label for="sale_quantity">الكمية:</label>
                    <input type="number" id="sale_quantity" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="sale_unit_price">سعر الوحدة:</label>
                    <input type="number" id="sale_unit_price" step="0.01" min="0" value="0.00" required>
                </div>
                <button onclick="addItemToCart()">إضافة إلى السلة</button>

                <h3 style="margin-top: 30px;">سلة المبيعات</h3>
                <table id="salesCartTable">
                    <thead>
                        <tr>
                            <th>الصنف</th>
                            <th>الكمية</th>
                            <th>سعر الوحدة</th>
                            <th>الإجمالي</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="salesCartBody">
                        <!-- Cart items will be loaded here -->
                    </tbody>
                </table>
                <div class="balance-summary" style="margin-top: 20px;">
                    <p>إجمالي السلة: <strong id="cartTotal">0.00</strong></p>
                </div>

                <h3 style="margin-top: 30px;">إتمام البيع</h3>
                <div class="form-group">
                    <label for="sale_payment_method">طريقة الدفع:</label>
                    <select id="sale_payment_method" onchange="updatePaymentDetails()">
                        <option value="نقدي">نقدي</option>
                        <option value="شبكة">شبكة</option>
                    </select>
                </div>
                <div class="form-group" id="saleAmountPaidGroup">
                    <label for="sale_amount_paid">المبلغ المدفوع (نقدي):</label>
                    <input type="number" id="sale_amount_paid" step="0.01" min="0" value="0.00" oninput="updatePaymentDetails()">
                </div>
                <div class="balance-summary">
                    <p>الباقي/المستحق: <strong id="saleChange">0.00</strong></p>
                </div>
                <button onclick="completeSale()" style="background-color: #007bff;">إتمام البيع</button>
                <button onclick="clearCart()" style="background-color: #e74c3c;">مسح السلة</button>
            </div>
        </div>

        <!-- Cash Journal / Inventory / Reports Application Section -->
        <div id="cashJournalAppContainer" class="page-section">
            <h1 style="display: none;">يوميات الصندوق والجرد اليومي</h1> <!-- العنوان الرئيسي مخفي هنا لأن الهيدر العلوي يكفي -->

            <!-- أزرار التبويبات للتنقل بين الأقسام الداخلية -->
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('cashJournal')">يوميات الصندوق</button>
                <button class="tab-button" onclick="showTab('inventory')">الجرد اليومي</button>
                <button class="tab-button" onclick="showTab('reports')">التقارير</button>
            </div>

            <!-- قسم يوميات الصندوق -->
            <div id="cashJournal" class="tab-content active">
                <div class="card">
                    <h2>إضافة/تعديل قيد يومية للصندوق</h2>
                    <div id="cashJournalMessage" class="message"></div> <!-- لعرض رسائل النجاح/الخطأ -->
                    <form id="cashJournalForm">
                        <input type="hidden" id="cj_entry_id" name="entry_id"> <!-- حقل مخفي لمعرف القيد عند التعديل -->
                        <div class="form-group">
                            <label for="cj_branch">الفرع:</label>
                            <select id="cj_branch" name="branch_id" required>
                                <!-- سيتم تحميل خيارات الفروع ديناميكيًا بواسطة JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cj_date">التاريخ:</label>
                            <input type="date" id="cj_date" name="entry_date" required>
                        </div>
                        <div class="form-group">
                            <label for="cj_description">البيان:</label>
                            <textarea id="cj_description" name="description" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="cj_type">نوع الحركة:</label>
                            <select id="cj_type" name="transaction_type" required>
                                <option value="إيراد نقدي">إيراد نقدي</option>
                                <option value="مصروف نقدي">مصروف نقدي</option>
                                <option value="إيراد شبكة">إيراد شبكة</option>
                                <option value="مصروف شبكة">مصروف شبكة</option>
                                <option value="إيداع بنكي">إيداع بنكي</option>
                                <option value="سحب بنكي">سحب بنكي</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cj_amount">المبلغ:</label>
                            <input type="number" id="cj_amount" name="amount" step="0.01" min="0" value="0" required>
                        </div>
                        <div class="form-group">
                            <label for="cj_payment_method">طريقة الدفع:</label>
                            <select id="cj_payment_method" name="payment_method" required>
                                <option value="نقدي">نقدي</option>
                                <option value="شبكة">شبكة</option>
                            </select>
                        </div>
                        <div class="form-group" id="checkNumberGroup" style="display: none;">
                            <label for="cj_check_number">رقم المرجع (شبكة / شيك):</label>
                            <input type="text" id="cj_check_number" name="check_number">
                        </div>
                        <div class="form-group">
                            <label for="cj_notes">ملاحظات:</label>
                            <textarea id="cj_notes" name="notes"></textarea>
                        </div>
                        <button type="submit" id="cj_submit_button">إضافة قيد</button>
                    </form>
                </div>

                <!-- قسم إدارة أرصدة الصندوق اليومية -->
                <div class="card balance-management-card daily-journal-section">
                    <h2>إدارة أرصدة الصندوق اليومية</h2>
                    <div id="balanceMessage" class="message"></div>
                    <form id="dailyBalanceForm">
                        <input type="hidden" id="balance_date" name="date">
                        <input type="hidden" id="balance_branch_id" name="branch_id">
                        <div class="form-group">
                            <label for="actual_ending_cash">الرصيد النقدي الفعلي الختامي:</label>
                            <input type="number" id="actual_ending_cash" name="actual_ending_cash" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label for="actual_ending_network">رصيد الشبكة الفعلي الختامي:</label>
                            <input type="number" id="actual_ending_network" name="actual_ending_network" step="0.01" value="0">
                        </div>
                        <button type="submit">حفظ أرصدة الصندوق</button>
                    </form>

                    <div class="balance-summary">
                        <h3>ملخص التسوية</h3>
                        <p>الرصيد النقدي الختامي (النظام): <strong id="system_ending_cash" class="calculated-value">0.00</strong></p>
                        <p>الفرق النقدي: <strong id="cash_discrepancy" class="discrepancy">0.00</strong></p>
                        <p>رصيد الشبكة الختامي (النظام): <strong id="system_ending_network" class="calculated-value">0.00</strong></p>
                        <p>الفرق الشبكي: <strong id="network_discrepancy" class="discrepancy">0.00</strong></p>
                    </div>
                </div>

                <div class="card daily-journal-section">
                    <h2>قيود يومية الصندوق اليومية</h2>
                    <div class="form-group">
                        <label for="view_cj_date">عرض تاريخ:</label>
                        <input type="date" id="view_cj_date" onchange="loadCashJournalEntries()">
                    </div>
                    <div class="form-group">
                        <label for="view_cj_branch">عرض فرع:</label>
                        <select id="view_cj_branch" onchange="loadCashJournalEntries()">
                            <!-- سيتم تحميل خيارات الفروع ديناميكيًا -->
                        </select>
                    </div>
                    <!-- إضافة فلتر نوع الحركة -->
                    <div class="form-group">
                        <label for="view_cj_transaction_type_filter">فلتر نوع الحركة:</label>
                        <select id="view_cj_transaction_type_filter" onchange="loadCashJournalEntries()">
                            <option value="">الكل</option>
                            <option value="إيراد">الإيرادات</option>
                            <option value="مصروف">المصروفات</option>
                            <option value="إيداع بنكي">إيداع بنكي</option>
                            <option value="سحب بنكي">سحب بنكي</option>
                        </select>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>الفرع</th>
                                <th>البيان</th>
                                <th>نوع الحركة</th>
                                <th>المبلغ</th>
                                <th>طريقة الدفع</th>
                                <th>رقم المرجع</th>
                                <th>ملاحظات</th>
                                <th>الإجراءات</th> <!-- عمود جديد للأزرار -->
                            </tr>
                        </thead>
                        <tbody id="cashJournalEntriesBody">
                            <!-- سيتم تحميل البيانات ديناميكيًا بواسطة JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="card summary-card daily-journal-section">
                    <h2>ملخص الصندوق اليومي (إجمالي الحركات)</h2>
                    <p>إجمالي الإيرادات النقدية: <strong id="totalCashIn">0.00</strong></p>
                    <p>إجمالي المصروفات النقدية: <strong id="totalCashOut">0.00</strong></p>
                    <p>إجمالي إيرادات الشبكة/الشيكات: <strong id="totalNetworkIn">0.00</strong></p>
                    <p>إجمالي مصروفات الشبكة/الشيكات: <strong id="totalNetworkOut">0.00</strong></p>
                    <p>صافي رصيد الصندوق النقدي: <strong id="netCashBalance">0.00</strong></p>
                </div>
            </div>

            <!-- قسم الجرد اليومي -->
            <div id="inventory" class="tab-content">
                <button class="back-button" onclick="showPage('mainPage')">العودة إلى الصفحة الرئيسية</button>
                <div class="card">
                    <h2>إضافة/تعديل قيد جرد يومي</h2>
                    <div id="inventoryMessage" class="message"></div>
                    <form id="inventoryForm">
                        <input type="hidden" id="inv_entry_id" name="entry_id"> <!-- حقل مخفي لمعرف القيد عند التعديل -->
                        <div class="form-group">
                            <label for="inv_branch">الفرع:</label>
                            <select id="inv_branch" name="branch_id" required>
                                <!-- سيتم تحميل خيارات الفروع ديناميكيًا -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="inv_date">التاريخ:</label>
                            <input type="date" id="inv_date" name="inventory_date" required>
                        </div>
                        <div class="form-group">
                            <label for="inv_item_desc">وصف الصنف:</label>
                            <input type="text" id="inv_item_desc" name="item_description" required>
                        </div>
                        <div class="form-group">
                            <label for="inv_initial_qty">الكمية الأولية:</label>
                            <input type="number" id="inv_initial_qty" name="initial_quantity" min="0" value="0" required>
                        </div>
                        <div class="form-group">
                            <label for="inv_sales_qty">كمية المبيعات:</label>
                            <input type="number" id="inv_sales_qty" name="sales_quantity" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="inv_returns_qty">كمية المرتجعات:</label>
                            <input type="number" id="inv_returns_qty" name="returns_quantity" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="inv_unit_price">سعر الوحدة:</label>
                            <input type="number" id="inv_unit_price" name="unit_price" step="0.01" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="inv_notes">ملاحظات:</label>
                            <textarea id="inv_notes" name="notes"></textarea>
                        </div>
                        <button type="submit" id="inv_submit_button">إضافة قيد جرد</button>
                    </form>
                </div>

                <div class="card daily-journal-section">
                    <h2>قيود الجرد اليومية</h2>
                    <div class="form-group">
                        <label for="view_inv_date">عرض تاريخ:</label>
                        <input type="date" id="view_inv_date" onchange="loadInventoryEntries()">
                    </div>
                    <div class="form-group">
                        <label for="view_inv_branch">عرض فرع:</label>
                        <select id="view_inv_branch" onchange="loadInventoryEntries()">
                            <!-- سيتم تحميل خيارات الفروع ديناميكيًا -->
                        </select>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>الفرع</th>
                                <th>وصف الصنف</th>
                                <th>الكمية الأولية</th>
                                <th>المبيعات</th>
                                <th>المرتجعات</th>
                                <th>الكمية النهائية</th>
                                <th>سعر الوحدة</th>
                                <th>القيمة الإجمالية</th>
                                <th>ملاحظات</th>
                                <th>الإجراءات</th> <!-- عمود جديد للأزرار -->
                            </tr>
                        </thead>
                        <tbody id="inventoryEntriesBody">
                            <!-- سيتم تحميل البيانات ديناميكيًا بواسطة JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- قسم التقارير -->
            <div id="reports" class="tab-content">
                <button class="back-button" onclick="showPage('mainPage')">العودة إلى الصفحة الرئيسية</button>
                <div class="card">
                    <h2>التقارير</h2>
                    <p class="text-muted">اختر الفترة والفرع لعرض التقارير.</p>
                    <div class="form-group">
                        <label for="report_start_date">تاريخ البدء:</label>
                        <input type="date" id="report_start_date">
                    </div>
                    <div class="form-group">
                        <label for="report_end_date">تاريخ الانتهاء:</label>
                        <input type="date" id="report_end_date">
                    </div>
                    <div class="form-group">
                        <label for="report_branch">الفرع:</label>
                        <select id="report_branch">
                            <!-- سيتم تحميل خيارات الفروع ديناميكيًا -->
                            <option value="">جميع الفروع</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="generateCashJournalReport()">عرض تقرير الصندوق</button>
                    <button class="btn-success" onclick="generateInventoryReport()">عرض تقرير الجرد</button>
                    <button class="btn-info" onclick="printReport('all')">طباعة جميع التقارير</button> <!-- الزر الجديد -->

                    <div class="add-from-report-buttons">
                        <button onclick="addCashJournalFromReport()">إضافة قيد يومية جديد</button>
                        <button onclick="addInventoryFromReport()">إضافة قيد جرد جديد</button>
                    </div>

                    <div class="card" style="margin-top: 30px;" id="cashJournalReportCard">
                        <h3>تقرير يومية الصندوق</h3>
                        <table id="cashJournalReportTable">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>الفرع</th>
                                    <th>البيان</th>
                                    <th>نوع الحركة</th>
                                    <th>المبلغ</th>
                                    <th>طريقة الدفع</th>
                                    <th>رقم المرجع</th>
                                    <th>الإجراءات</th> <!-- عمود الإجراءات في التقرير -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- سيتم تحميل بيانات التقرير هنا -->
                            </tbody>
                        </table>
                        <button class="btn-info print-button" onclick="printReport('cashJournalReportTable')">طباعة التقرير</button>
                    </div>

                    <div class="card" style="margin-top: 30px;" id="inventoryReportCard">
                        <h3>تقرير الجرد</h3>
                        <table id="inventoryReportTable">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>الفرع</th>
                                    <th>وصف الصنف</th>
                                    <th>الكمية الأولية</th>
                                    <th>المبيعات</th>
                                    <th>المرتجعات</th>
                                    <th>الكمية النهائية</th>
                                    <th>سعر الوحدة</th>
                                    <th>القيمة الإجمالية</th>
                                    <th>الإجراءات</th> <!-- عمود الإجراءات في التقرير -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- سيتم تحميل بيانات التقرير هنا -->
                            </tbody>
                        </table>
                        <button class="btn-info print-button" onclick="printReport('inventoryReportTable')">طباعة التقرير</button>
                    </div>
                </div>
            </div>

            <!-- قسم إدارة الفروع الجديد -->
            <div id="branchManagement" class="page-section">
                <button class="back-button" onclick="showPage('mainPage')">العودة إلى الصفحة الرئيسية</button>
                <div class="card">
                    <h2>إدارة الفروع</h2>
                    <div id="branchMessage" class="message"></div>
                    <div class="form-group">
                        <label for="newBranchName">اسم الفرع الجديد:</label>
                        <input type="text" id="newBranchName" placeholder="أدخل اسم الفرع" required>
                    </div>
                    <button onclick="addBranch()">إضافة فرع جديد</button>

                    <h3 style="margin-top: 30px;">الفروع الحالية</h3>
                    <table id="branchesTable">
                        <thead>
                            <tr>
                                <th>المعرف</th>
                                <th>اسم الفرع</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="branchesTableBody">
                            <!-- سيتم تحميل الفروع هنا -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- قسم إعدادات المظهر الجديد -->
            <div id="appearanceSettings" class="page-section">
                <button class="back-button" onclick="showPage('mainPage')">العودة إلى الصفحة الرئيسية</button>
                <div class="card">
                    <h2>إعدادات المظهر</h2>
                    <p class="text-muted">قم بتخصيص مظهر النظام.</p>

                    <div class="form-group">
                        <label for="bgColor">لون الخلفية (الجسم):</label>
                        <input type="color" id="bgColor" value="#f4f7f6" onchange="applyAppearanceSettings()">
                    </div>
                    <div class="form-group">
                        <label for="headerBgColor">لون خلفية شريط الرأس:</label>
                        <input type="color" id="headerBgColor" value="#2c3e50" onchange="applyAppearanceSettings()">
                    </div>
                    <div class="form-group">
                        <label for="containerBgColor">لون خلفية الحاوية:</label>
                        <input type="color" id="containerBgColor" value="#ffffff" onchange="applyAppearanceSettings()">
                    </div>
                    <div class="form-group">
                        <label for="cardBgColor">لون خلفية البطاقات:</label>
                        <input type="color" id="cardBgColor" value="#ecf0f1" onchange="applyAppearanceSettings()">
                    </div>

                    <div class="form-group">
                        <label for="bgImageUrl">رابط صورة الخلفية (URL):</label>
                        <input type="text" id="bgImageUrl" placeholder="أدخل رابط الصورة هنا" oninput="applyAppearanceSettings()">
                    </div>

                    <div class="form-group">
                        <label for="bgRepeat">تكرار الصورة:</label>
                        <select id="bgRepeat" onchange="applyAppearanceSettings()">
                            <option value="no-repeat">لا تكرار</option>
                            <option value="repeat">تكرار</option>
                            <option value="repeat-x">تكرار أفقي</option>
                            <option value="repeat-y">تكرار عمودي</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="bgSize">حجم الصورة:</label>
                        <select id="bgSize" onchange="applyAppearanceSettings()">
                            <option value="auto">تلقائي</option>
                            <option value="cover">تغطية</option>
                            <option value="contain">احتواء</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="bgPosition">موضع الصورة:</label>
                        <select id="bgPosition" onchange="applyAppearanceSettings()">
                            <option value="center center">المنتصف</option>
                            <option value="top center">أعلى المنتصف</option>
                            <option value="bottom center">أسفل المنتصف</option>
                            <option value="top left">أعلى اليمين</option>
                            <option value="top right">أعلى اليسار</option>
                            <option value="bottom left">أسفل اليمين</option>
                            <option value="bottom right">أسفل اليسار</option>
                        </select>
                    </div>

                    <button onclick="resetAppearanceSettings()" style="background-color: #e74c3c;">إعادة تعيين الإعدادات</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // JavaScript لجميع التفاعلات الديناميكية في الواجهة الأمامية

        // دالة لحفظ البيانات في localStorage
        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        // دالة لجلب البيانات من localStorage
        function getData(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        // تهيئة البيانات عند التحميل الأول إذا لم تكن موجودة
        // الفروع - سيتم تحميلها من localStorage أو تهيئتها بقيم افتراضية
        let branches = getData('branches');
        if (branches.length === 0) {
            branches = [
                { id: 'branch1', name: 'الفرع الرئيسي', location: 'الرياض' },
                { id: 'branch2', name: 'فرع جدة', location: 'جدة' },
                { id: 'branch3', name: 'فرع الدمام', location: 'الدمام' }
            ];
            saveData('branches', branches);
        }

        // سلة المبيعات الحالية (لكل عملية بيع)
        let salesCart = [];

        // تهيئة البيانات الأخرى
        if (!localStorage.getItem('cashJournalEntries')) {
            saveData('cashJournalEntries', []);
        }
        if (!localStorage.getItem('inventoryEntries')) {
            saveData('inventoryEntries', []);
        }
        if (!localStorage.getItem('dailyBalances')) {
            saveData('dailyBalances', []);
        }
        if (!localStorage.getItem('salesEntries')) {
            saveData('salesEntries', []);
        }
        // تهيئة إعدادات المظهر
        if (!localStorage.getItem('appearanceSettings')) {
            saveData('appearanceSettings', {
                bgColor: '#f4f7f6',
                headerBgColor: '#2c3e50',
                containerBgColor: '#ffffff',
                cardBgColor: '#ecf0f1',
                bgImageUrl: '',
                bgRepeat: 'repeat',
                bgSize: 'auto',
                bgPosition: 'center center'
            });
        }

        // Functions for Appearance Settings
        function applyAppearanceSettings() {
            const bgColor = document.getElementById('bgColor')?.value;
            const headerBgColor = document.getElementById('headerBgColor')?.value;
            const containerBgColor = document.getElementById('containerBgColor')?.value;
            const cardBgColor = document.getElementById('cardBgColor')?.value;
            const bgImageUrl = document.getElementById('bgImageUrl')?.value;
            const bgRepeat = document.getElementById('bgRepeat')?.value;
            const bgSize = document.getElementById('bgSize')?.value;
            const bgPosition = document.getElementById('bgPosition')?.value;

            const body = document.body;
            const appHeader = document.querySelector('.app-header');
            const container = document.querySelector('.container');
            const cards = document.querySelectorAll('.card');

            // Apply background color to body
            body.style.backgroundColor = bgColor || '#f4f7f6';

            // Apply background color to header
            if (appHeader) appHeader.style.backgroundColor = headerBgColor || '#2c3e50';

            // Apply background color to container
            if (container) container.style.backgroundColor = containerBgColor || '#ffffff';

            // Apply background color to cards
            cards.forEach(card => {
                card.style.backgroundColor = cardBgColor || '#ecf0f1';
            });

            // Apply background image settings
            if (bgImageUrl) {
                body.style.backgroundImage = `url('${bgImageUrl}')`;
                body.style.backgroundRepeat = bgRepeat;
                body.style.backgroundSize = bgSize;
                body.style.backgroundPosition = bgPosition;
            } else {
                body.style.backgroundImage = 'none'; // Remove image if URL is empty
            }

            // Save settings to localStorage
            saveData('appearanceSettings', {
                bgColor: bgColor,
                headerBgColor: headerBgColor,
                containerBgColor: containerBgColor,
                cardBgColor: cardBgColor,
                bgImageUrl: bgImageUrl,
                bgRepeat: bgRepeat,
                bgSize: bgSize,
                bgPosition: bgPosition
            });
        }

        function loadAppearanceSettings() {
            const settings = getData('appearanceSettings');
            if (settings) {
                document.getElementById('bgColor').value = settings.bgColor || '#f4f7f6';
                document.getElementById('headerBgColor').value = settings.headerBgColor || '#2c3e50';
                document.getElementById('containerBgColor').value = settings.containerBgColor || '#ffffff';
                document.getElementById('cardBgColor').value = settings.cardBgColor || '#ecf0f1';
                document.getElementById('bgImageUrl').value = settings.bgImageUrl || '';
                document.getElementById('bgRepeat').value = settings.bgRepeat || 'repeat';
                document.getElementById('bgSize').value = settings.bgSize || 'auto';
                document.getElementById('bgPosition').value = settings.bgPosition || 'center center';
                
                // Apply loaded settings to the body and other elements
                applyAppearanceSettings();
            }
        }

        function resetAppearanceSettings() {
            // Reset to default values
            const defaultSettings = {
                bgColor: '#f4f7f6',
                headerBgColor: '#2c3e50',
                containerBgColor: '#ffffff',
                cardBgColor: '#ecf0f1',
                bgImageUrl: '',
                bgRepeat: 'repeat',
                bgSize: 'auto',
                bgPosition: 'center center'
            };
            saveData('appearanceSettings', defaultSettings); // Save defaults

            // Update input fields
            document.getElementById('bgColor').value = defaultSettings.bgColor;
            document.getElementById('headerBgColor').value = defaultSettings.headerBgColor;
            document.getElementById('containerBgColor').value = defaultSettings.containerBgColor;
            document.getElementById('cardBgColor').value = defaultSettings.cardBgColor;
            document.getElementById('bgImageUrl').value = defaultSettings.bgImageUrl;
            document.getElementById('bgRepeat').value = defaultSettings.bgRepeat;
            document.getElementById('bgSize').value = defaultSettings.bgSize;
            document.getElementById('bgPosition').value = defaultSettings.bgPosition;

            applyAppearanceSettings(); // Apply the default settings to the body
            showMessage('generalMessage', 'success', 'تمت إعادة تعيين إعدادات المظهر بنجاح.');
        }


        document.addEventListener('DOMContentLoaded', function() {
            loadBranches(); // تحميل الفروع عند تحميل الصفحة
            showPage('mainPage'); // إظهار الصفحة الرئيسية افتراضيًا
            loadAppearanceSettings(); // تطبيق إعدادات المظهر المحفوظة عند التحميل
            
            // تعيين التاريخ الحالي لجميع حقول التاريخ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('cj_date').value = today;
            document.getElementById('inv_date').value = today;
            document.getElementById('view_cj_date').value = today;
            document.getElementById('view_inv_date').value = today;
            document.getElementById('report_start_date').value = today;
            document.getElementById('report_end_date').value = today;

            // معالج حدث لتقديم نموذج يوميات الصندوق
            document.getElementById('cashJournalForm').addEventListener('submit', function(e) {
                e.preventDefault(); // منع الإرسال الافتراضي للنموذج
                const formData = new FormData(this);
                const newEntry = Object.fromEntries(formData.entries());

                // إضافة معرف الفرع واسمه
                const selectedBranch = branches.find(b => b.id === newEntry.branch_id);
                if (selectedBranch) {
                    newEntry.branch_name = selectedBranch.name;
                } else {
                    showMessage('cashJournalMessage', 'error', 'الرجاء اختيار فرع صحيح.');
                    return;
                }

                // التحقق من رقم المرجع إذا كانت طريقة الدفع "شبكة"
                if (newEntry.payment_method === 'شبكة' && !newEntry.check_number) {
                    showMessage('cashJournalMessage', 'error', 'الرجاء إدخال رقم المرجع لطريقة الدفع "شبكة".');
                    return;
                }
                if (newEntry.payment_method !== 'شبكة') {
                    newEntry.check_number = ''; // مسح رقم المرجع إذا لم تكن شبكة
                }


                let entries = getData('cashJournalEntries');
                const entryId = document.getElementById('cj_entry_id');
                const cjSubmitButton = document.getElementById('cj_submit_button');

                if (entryId && entryId.value) {
                    // وضع التعديل: البحث عن القيد وتحديثه
                    const index = entries.findIndex(entry => entry.id === entryId.value);
                    if (index !== -1) {
                        // تحديث فقط الحقول التي يمكن تعديلها
                        entries[index].branch_id = newEntry.branch_id;
                        entries[index].branch_name = newEntry.branch_name;
                        entries[index].entry_date = newEntry.entry_date;
                        entries[index].description = newEntry.description;
                        entries[index].transaction_type = newEntry.transaction_type;
                        entries[index].amount = newEntry.amount;
                        entries[index].payment_method = newEntry.payment_method;
                        entries[index].check_number = newEntry.check_number;
                        entries[index].notes = newEntry.notes;
                        showMessage('cashJournalMessage', 'success', 'تم تحديث قيد الصندوق بنجاح.');
                    } else {
                        showMessage('cashJournalMessage', 'error', 'خطأ: لم يتم العثور على القيد للتحديث.');
                    }
                } else {
                    // وضع الإضافة: إضافة قيد جديد بمعرف فريد
                    newEntry.id = 'cj_' + Date.now(); // إضافة معرف فريد
                    entries.push(newEntry);
                    showMessage('cashJournalMessage', 'success', 'تمت إضافة قيد الصندوق بنجاح.');
                }
                
                saveData('cashJournalEntries', entries);
                this.reset(); // إعادة تعيين النموذج
                document.getElementById('cj_date').value = today; // إعادة تعيين التاريخ لليوم الحالي
                if (entryId) entryId.value = ''; // مسح معرف القيد من الحقل المخفي
                if (cjSubmitButton) {
                    cjSubmitButton.textContent = 'إضافة قيد'; // إعادة الزر إلى وضع الإضافة
                    cjSubmitButton.classList.remove('update-mode'); // إزالة فئة وضع التحديث
                }
                loadCashJournalEntries(); // إعادة تحميل جدول القيود وتحديث الملخص
                calculateAndDisplayDailyBalances(today, null, 'mainPage'); // تحديث ملخص الصفحة الرئيسية
            });

            // معالج حدث لتقديم نموذج الجرد
            document.getElementById('inventoryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const newEntry = Object.fromEntries(formData.entries());

                // إضافة معرف الفرع واسمه
                const selectedBranch = branches.find(b => b.id === newEntry.branch_id);
                if (selectedBranch) {
                    newEntry.branch_name = selectedBranch.name;
                } else {
                    showMessage('inventoryMessage', 'error', 'الرجاء اختيار فرع صحيح.');
                    return;
                }

                // تحويل الكميات والأسعار إلى أرقام
                newEntry.initial_quantity = parseInt(newEntry.initial_quantity) || 0;
                newEntry.sales_quantity = parseInt(newEntry.sales_quantity) || 0;
                newEntry.returns_quantity = parseInt(newEntry.returns_quantity) || 0;
                newEntry.unit_price = parseFloat(newEntry.unit_price) || 0;
                
                // حساب الكمية النهائية والقيمة الإجمالية
                newEntry.final_quantity = newEntry.initial_quantity - newEntry.sales_quantity + newEntry.returns_quantity;
                newEntry.total_value = (newEntry.final_quantity * newEntry.unit_price).toFixed(2);

                let entries = getData('inventoryEntries');
                const entryId = document.getElementById('inv_entry_id');
                const invSubmitButton = document.getElementById('inv_submit_button');

                if (entryId && entryId.value) {
                    // وضع التعديل: البحث عن القيد وتحديثه
                    const index = entries.findIndex(entry => entry.id === entryId.value);
                    if (index !== -1) {
                        // تحديث فقط الحقول التي يمكن تعديلها
                        entries[index].branch_id = newEntry.branch_id;
                        entries[index].branch_name = newEntry.branch_name;
                        entries[index].inventory_date = newEntry.inventory_date;
                        entries[index].item_description = newEntry.item_description;
                        entries[index].initial_quantity = newEntry.initial_quantity;
                        entries[index].sales_quantity = newEntry.sales_quantity;
                        entries[index].returns_quantity = newEntry.returns_quantity;
                        entries[index].final_quantity = newEntry.final_quantity; // محسوبة
                        entries[index].unit_price = newEntry.unit_price;
                        entries[index].total_value = newEntry.total_value; // محسوبة
                        entries[index].notes = newEntry.notes;
                        showMessage('inventoryMessage', 'success', 'تم تحديث قيد الجرد بنجاح.');
                    } else {
                        showMessage('inventoryMessage', 'error', 'خطأ: لم يتم العثور على القيد للتحديث.');
                    }
                } else {
                    // التحقق من عدم تكرار الصنف في نفس اليوم والفرع عند الإضافة
                    const isDuplicate = entries.some(entry => 
                        entry.branch_id === newEntry.branch_id &&
                        entry.inventory_date === newEntry.inventory_date &&
                        entry.item_description === newEntry.item_description
                    );

                    if (isDuplicate) {
                        showMessage('inventoryMessage', 'error', 'هذا الصنف موجود بالفعل في الجرد لهذا التاريخ والفرع. الرجاء التعديل أو إدخال صنف مختلف.');
                        return;
                    }
                    // وضع الإضافة: إضافة قيد جديد بمعرف فريد
                    newEntry.id = 'inv_' + Date.now(); // إضافة معرف فريد
                    entries.push(newEntry);
                    showMessage('inventoryMessage', 'success', 'تمت إضافة قيد الجرد بنجاح.');
                }

                saveData('inventoryEntries', entries);
                this.reset();
                document.getElementById('inv_date').value = today; // إعادة تعيين التاريخ لليوم الحالي
                if (entryId) entryId.value = ''; // مسح معرف القيد من الحقل المخفي
                if (invSubmitButton) {
                    invSubmitButton.textContent = 'إضافة قيد جرد'; // إعادة الزر إلى وضع الإضافة
                    invSubmitButton.classList.remove('update-mode'); // إزالة فئة وضع التحديث
                }
                loadInventoryEntries(); // إعادة تحميل جدول الجرد
            });

            // معالج حدث لتقديم نموذج أرصدة الصندوق اليومية
            document.getElementById('dailyBalanceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const balanceData = Object.fromEntries(formData.entries());

                const date = document.getElementById('view_cj_date')?.value;
                const branchId = document.getElementById('view_cj_branch')?.value;

                if (!date || !branchId) {
                    showMessage('balanceMessage', 'error', 'الرجاء تحديد التاريخ والفرع أولاً.');
                    return;
                }

                balanceData.date = date;
                balanceData.branch_id = branchId;
                // لم نعد نستخدم opening_cash و opening_network
                balanceData.actual_ending_cash = parseFloat(balanceData.actual_ending_cash) || 0;
                balanceData.actual_ending_network = parseFloat(balanceData.actual_ending_network) || 0;

                let dailyBalances = getData('dailyBalances');
                const existingIndex = dailyBalances.findIndex(b => b.date === date && b.branch_id === branchId);

                if (existingIndex !== -1) {
                    dailyBalances[existingIndex] = balanceData; // تحديث القيد الموجود
                    showMessage('balanceMessage', 'success', 'تم تحديث أرصدة الصندوق بنجاح.');
                } else {
                    dailyBalances.push(balanceData); // إضافة قيد جديد
                    showMessage('balanceMessage', 'success', 'تم حفظ أرصدة الصندوق بنجاح.');
                }
                saveData('dailyBalances', dailyBalances);
                calculateAndDisplayDailyBalances(date, branchId); // إعادة حساب وعرض الملخص للتبويب
                calculateAndDisplayDailyBalances(today, null, 'mainPage'); // تحديث ملخص الصفحة الرئيسية
            });


            // تبديل حقل رقم المرجع بناءً على طريقة الدفع (نقدي/شبكة)
            document.getElementById('cj_payment_method').addEventListener('change', function() {
                const checkNumberGroup = document.getElementById('checkNumberGroup');
                const cjCheckNumber = document.getElementById('cj_check_number');
                if (checkNumberGroup && cjCheckNumber) { // Added checks here too
                    if (this.value === 'شبكة') {
                        checkNumberGroup.style.display = 'block';
                        cjCheckNumber.setAttribute('required', 'required');
                    } else {
                        checkNumberGroup.style.display = 'none';
                        cjCheckNumber.removeAttribute('required');
                    }
                }
            });

            // تحميل القيود اليومية والجرد عند تحميل الصفحة
            loadCashJournalEntries();
            loadInventoryEntries();
        });

        // دالة لعرض الأقسام الرئيسية (الصفحة الرئيسية أو تطبيق يوميات الصندوق)
        function showPage(pageId) {
            console.log('Attempting to show page:', pageId); // Debugging log
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
                console.log('Removed active from:', section.id); // Debugging log
            });
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                console.log('Added active to:', targetPage.id); // Debugging log
            } else {
                console.error('Target page element not found:', pageId); // Error log
            }

            // إذا تم التبديل إلى cashJournalAppContainer، تأكد من تنشيط أول تبويب داخلي
            if (pageId === 'cashJournalAppContainer') {
                showTab('cashJournal'); // تنشيط تبويب يوميات الصندوق افتراضيًا
            } else if (pageId === 'mainPage') {
                const today = new Date().toISOString().split('T')[0];
                calculateAndDisplayDailyBalances(today, null, 'mainPage'); // تحديث ملخص الصفحة الرئيسية
            } else if (pageId === 'salesCashier') {
                clearCart(); // مسح السلة عند الدخول لواجهة الكاشير
            } else if (pageId === 'appearanceSettings') {
                loadAppearanceSettings(); // تحميل إعدادات المظهر عند الدخول للصفحة
            } else if (pageId === 'branchManagement') {
                loadBranchList(); // تحميل قائمة الفروع عند الدخول لصفحة إدارة الفروع
            }
            window.scrollTo({ top: 0, behavior: 'smooth' }); // التمرير لأعلى الصفحة
        }

        // دالة لعرض التبويبات الداخلية (يوميات الصندوق، الجرد، التقارير)
        function showTab(tabId) {
            document.querySelectorAll('#cashJournalAppContainer .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#cashJournalAppContainer .tab-button').forEach(button => {
                button.classList.remove('active');
            });
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            const targetButton = document.querySelector(`#cashJournalAppContainer .tab-button[onclick="showTab('${tabId}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }

            // إعادة تحميل البيانات عند التبديل بين التبويبات
            if (tabId === 'cashJournal') {
                loadCashJournalEntries();
            } else if (tabId === 'inventory') {
                loadInventoryEntries();
            } else if (tabId === 'reports') {
                // مسح بيانات التقارير السابقة
                const cashJournalReportTableBody = document.getElementById('cashJournalReportTable')?.querySelector('tbody');
                if (cashJournalReportTableBody) cashJournalReportTableBody.innerHTML = '';
                const inventoryReportTableBody = document.getElementById('inventoryReportTable')?.querySelector('tbody');
                if (inventoryReportTableBody) inventoryReportTableBody.innerHTML = '';
            }
            window.scrollTo({ top: 0, behavior: 'smooth' }); // التمرير لأعلى الصفحة
        }

        // دالة لعرض رسائل النجاح أو الخطأ
        function showMessage(elementId, type, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `message ${type}`;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none'; // إخفاء الرسالة بعد 5 ثوانٍ
                }, 5000);
            }
        }

        // تحميل قائمة الفروع وملء القوائم المنسدلة
        function loadBranches() {
            // إعادة تحميل الفروع من localStorage لضمان أحدث البيانات
            branches = getData('branches');

            const branchSelects = document.querySelectorAll('select[name="branch_id"], #view_cj_branch, #view_inv_branch, #report_branch');
            
            branchSelects.forEach(selectElement => {
                selectElement.innerHTML = ''; // مسح الخيارات الحالية
                // إضافة خيار افتراضي "اختر فرع"
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- اختر فرع --';
                selectElement.appendChild(defaultOption);

                // إضافة الفروع من البيانات المحاكاة
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id;
                    option.textContent = branch.name;
                    selectElement.appendChild(option);
                });
            });
        }

        // دالة لإضافة فرع جديد
        function addBranch() {
            const newBranchNameInput = document.getElementById('newBranchName');
            const newBranchName = newBranchNameInput?.value.trim();

            if (!newBranchName) {
                showMessage('branchMessage', 'error', 'الرجاء إدخال اسم الفرع.');
                return;
            }

            // التحقق من عدم تكرار اسم الفرع
            const isDuplicate = branches.some(branch => branch.name === newBranchName);
            if (isDuplicate) {
                showMessage('branchMessage', 'error', 'هذا الفرع موجود بالفعل.');
                return;
            }

            const newBranch = {
                id: 'branch_' + Date.now(), // معرف فريد للفرع
                name: newBranchName,
                location: '' // يمكن إضافة حقل للموقع لاحقًا إذا لزم الأمر
            };

            branches.push(newBranch);
            saveData('branches', branches);
            showMessage('branchMessage', 'success', `تمت إضافة الفرع "${newBranchName}" بنجاح.`);
            newBranchNameInput.value = ''; // مسح حقل الإدخال
            loadBranches(); // إعادة تحميل قوائم الفروع المنسدلة
            loadBranchList(); // تحديث قائمة الفروع في صفحة الإدارة
        }

        // دالة لحذف فرع
        function deleteBranch(branchId) {
            if (confirm('هل أنت متأكد أنك تريد حذف هذا الفرع؟ سيؤدي هذا إلى حذف جميع البيانات المرتبطة به (قيود الصندوق، الجرد، المبيعات).')) {
                const initialLength = branches.length;
                branches = branches.filter(branch => branch.id !== branchId);
                
                if (branches.length < initialLength) {
                    saveData('branches', branches);
                    showMessage('branchMessage', 'success', 'تم حذف الفرع بنجاح.');
                    
                    // حذف البيانات المرتبطة بالفرع المحذوف من جميع الجداول
                    let cjEntries = getData('cashJournalEntries');
                    cjEntries = cjEntries.filter(entry => entry.branch_id !== branchId);
                    saveData('cashJournalEntries', cjEntries);

                    let invEntries = getData('inventoryEntries');
                    invEntries = invEntries.filter(entry => entry.branch_id !== branchId);
                    saveData('inventoryEntries', invEntries);

                    let dailyBalances = getData('dailyBalances');
                    dailyBalances = dailyBalances.filter(balance => balance.branch_id !== branchId);
                    saveData('dailyBalances', dailyBalances);

                    // يمكن إضافة منطق لحذف بيانات المبيعات المرتبطة بالفرع هنا إذا كانت المبيعات مرتبطة بفروع
                    // حاليًا، واجهة الكاشير لا تختار الفرع، لذا قد لا تكون هناك حاجة لحذف بيانات المبيعات حسب الفرع.

                    loadBranches(); // إعادة تحميل قوائم الفروع المنسدلة
                    loadBranchList(); // تحديث قائمة الفروع في صفحة الإدارة
                    // إعادة تحميل القيود والجرد والتقارير إذا كانت الصفحة النشطة هي إحداها
                    const activePage = document.querySelector('.page-section.active')?.id;
                    if (activePage === 'cashJournalAppContainer') {
                        loadCashJournalEntries();
                        loadInventoryEntries();
                    }
                    const today = new Date().toISOString().split('T')[0];
                    calculateAndDisplayDailyBalances(today, null, 'mainPage'); // تحديث ملخص الصفحة الرئيسية
                } else {
                    showMessage('branchMessage', 'error', 'خطأ: لم يتم العثور على الفرع للحذف.');
                }
            }
        }

        // دالة لعرض قائمة الفروع في جدول إدارة الفروع
        function loadBranchList() {
            const tableBody = document.getElementById('branchesTableBody');
            if (tableBody) {
                tableBody.innerHTML = ''; // مسح الفروع الحالية
            }

            if (branches.length > 0) {
                branches.forEach(branch => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = branch.id;
                    row.insertCell().textContent = branch.name;
                    
                    const actionsCell = row.insertCell();
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'حذف';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.style.width = 'auto';
                    deleteButton.style.padding = '5px 10px';
                    deleteButton.style.fontSize = '14px';
                    deleteButton.onclick = () => deleteBranch(branch.id);
                    actionsCell.appendChild(deleteButton);
                });
            } else {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 3;
                cell.textContent = 'لا توجد فروع مضافة.';
                cell.style.textAlign = 'center';
                cell.style.color = '#777';
            }
        }


        // دالة لحساب وعرض أرصدة الصندوق اليومية والفرق
        // تأخذ التاريخ والفرع المراد عرض الملخص لهما، ومعرف بادئة للعناصر (إذا كانت للصفحة الرئيسية)
        function calculateAndDisplayDailyBalances(date, branchId, prefix = '') {
            const today = new Date().toISOString().split('T')[0];
            let targetDate = date || document.getElementById('view_cj_date')?.value || today;
            let targetBranchId = branchId || document.getElementById('view_cj_branch')?.value || ''; // فارغ يعني كل الفروع

            const allTransactions = getData('cashJournalEntries');
            const dailyBalances = getData('dailyBalances');

            // حساب الإيرادات والمصروفات بناءً على التاريخ والفرع المستهدفين
            let totalCashIn = 0;
            let totalCashOut = 0;
            let totalNetworkIn = 0;
            let totalNetworkOut = 0;

            allTransactions.filter(entry => {
                const matchesDate = entry.entry_date === targetDate;
                const matchesBranch = (targetBranchId === '' || entry.branch_id === targetBranchId);
                return matchesDate && matchesBranch;
            }).forEach(entry => {
                const amount = parseFloat(entry.amount);
                if (entry.transaction_type.includes('إيراد')) {
                    if (entry.payment_method === 'نقدي') totalCashIn += amount;
                    else if (entry.payment_method === 'شبكة') totalNetworkIn += amount;
                } else if (entry.transaction_type.includes('مصروف')) {
                    if (entry.payment_method === 'نقدي') totalCashOut += amount;
                    else if (entry.payment_method === 'شبكة') totalNetworkOut += amount;
                }
            });

            // تحديث عناصر الملخص في تبويب يوميات الصندوق
            if (prefix === '') { // فقط إذا لم يكن هناك بادئة، أي للتبويب الأصلي
                const currentBalanceRecord = dailyBalances.find(b => b.date === targetDate && b.branch_id === targetBranchId) || {
                    actual_ending_cash: 0,
                    actual_ending_network: 0
                };

                const actualEndingCashInput = document.getElementById('actual_ending_cash');
                if (actualEndingCashInput) actualEndingCashInput.value = currentBalanceRecord.actual_ending_cash.toFixed(2);
                const actualEndingNetworkInput = document.getElementById('actual_ending_network');
                if (actualEndingNetworkInput) actualEndingNetworkInput.value = currentBalanceRecord.actual_ending_network.toFixed(2);
                const balanceDateInput = document.getElementById('balance_date');
                if (balanceDateInput) balanceDateInput.value = targetDate;
                const balanceBranchIdInput = document.getElementById('balance_branch_id');
                if (balanceBranchIdInput) balanceBranchIdInput.value = targetBranchId;

                const systemEndingCash = totalCashIn - totalCashOut;
                const systemEndingNetwork = totalNetworkIn - totalNetworkOut;

                const cashDiscrepancy = currentBalanceRecord.actual_ending_cash - systemEndingCash;
                const networkDiscrepancy = currentBalanceRecord.actual_ending_network - systemEndingNetwork;

                const systemEndingCashElement = document.getElementById('system_ending_cash');
                if (systemEndingCashElement) systemEndingCashElement.textContent = systemEndingCash.toFixed(2);
                const cashDiscrepancyElement = document.getElementById('cash_discrepancy');
                if (cashDiscrepancyElement) cashDiscrepancyElement.textContent = cashDiscrepancy.toFixed(2);
                const systemEndingNetworkElement = document.getElementById('system_ending_network');
                if (systemEndingNetworkElement) systemEndingNetworkElement.textContent = systemEndingNetwork.toFixed(2);
                const networkDiscrepancyElement = document.getElementById('network_discrepancy');
                if (networkDiscrepancyElement) networkDiscrepancyElement.textContent = networkDiscrepancy.toFixed(2);

                if (cashDiscrepancyElement) cashDiscrepancyElement.className = 'discrepancy ' + (cashDiscrepancy > 0 ? 'positive' : (cashDiscrepancy < 0 ? 'negative' : 'zero'));
                if (networkDiscrepancyElement) networkDiscrepancyElement.className = 'discrepancy ' + (networkDiscrepancy > 0 ? 'positive' : (networkDiscrepancy < 0 ? 'negative' : 'zero'));
            }

            // تحديث قيم الملخص الإجمالي (سواء في التبويب أو الصفحة الرئيسية)
            const totalCashInElement = document.getElementById(prefix + 'totalCashIn');
            if (totalCashInElement) totalCashInElement.textContent = totalCashIn.toFixed(2);
            const totalCashOutElement = document.getElementById(prefix + 'totalCashOut');
            if (totalCashOutElement) totalCashOutElement.textContent = totalCashOut.toFixed(2);
            const totalNetworkInElement = document.getElementById(prefix + 'totalNetworkIn');
            if (totalNetworkInElement) totalNetworkInElement.textContent = totalNetworkIn.toFixed(2);
            const totalNetworkOutElement = document.getElementById(prefix + 'totalNetworkOut');
            if (totalNetworkOutElement) totalNetworkOutElement.textContent = totalNetworkOut.toFixed(2);
            const netCashBalanceElement = document.getElementById(prefix + 'netCashBalance');
            if (netCashBalanceElement) netCashBalanceElement.textContent = (totalCashIn - totalCashOut).toFixed(2);
        }

        // تحميل قيود يومية الصندوق وعرضها في الجدول
        function loadCashJournalEntries() {
            const date = document.getElementById('view_cj_date')?.value;
            const branchId = document.getElementById('view_cj_branch')?.value;
            const transactionTypeFilter = document.getElementById('view_cj_transaction_type_filter')?.value; // جلب قيمة الفلتر الجديد

            const allEntries = getData('cashJournalEntries');
            let filteredEntries = allEntries.filter(entry => {
                let matchesDateAndBranch = (entry.entry_date === date) && 
                                           (branchId === '' || entry.branch_id === branchId);
                
                // تطبيق فلتر نوع الحركة
                if (transactionTypeFilter === 'إيراد') {
                    return matchesDateAndBranch && entry.transaction_type.includes('إيراد');
                } else if (transactionTypeFilter === 'مصروف') {
                    return matchesDateAndBranch && entry.transaction_type.includes('مصروف');
                } else if (transactionTypeFilter === 'إيداع بنكي' || transactionTypeFilter === 'سحب بنكي') {
                    return matchesDateAndBranch && entry.transaction_type === transactionTypeFilter;
                } else {
                    return matchesDateAndBranch; // عرض الكل
                }
            });

            // فرز القيود تنازليًا حسب التاريخ ثم حسب معرف القيد (للحفاظ على ترتيب الإدخال)
            filteredEntries.sort((a, b) => {
                if (a.entry_date !== b.entry_date) {
                    return b.entry_date.localeCompare(a.entry_date);
                }
                // استخدم معرف القيد للفرز الثانوي إذا كانت المعرفات أرقامًا
                return parseInt(b.id.split('_')[1]) - parseInt(a.id.split('_')[1]); 
            });


            const tableBody = document.getElementById('cashJournalEntriesBody');
            if (tableBody) {
                tableBody.innerHTML = ''; // مسح القيود الحالية
            }

            if (filteredEntries.length > 0) {
                filteredEntries.forEach(entry => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = entry.entry_date;
                    row.insertCell().textContent = entry.branch_name;
                    row.insertCell().textContent = entry.description;
                    row.insertCell().textContent = entry.transaction_type;
                    row.insertCell().textContent = parseFloat(entry.amount).toFixed(2);
                    row.insertCell().textContent = entry.payment_method;
                    row.insertCell().textContent = entry.check_number || '-';
                    row.insertCell().textContent = entry.notes || '-';
                    
                    // إضافة أزرار الإجراءات
                    const actionsCell = row.insertCell();
                    actionsCell.classList.add('action-buttons');
                    const editButton = document.createElement('button');
                    editButton.textContent = 'تعديل';
                    editButton.classList.add('edit-btn');
                    editButton.onclick = () => editCashJournalEntry(entry.id);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'حذف';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.onclick = () => deleteCashJournalEntry(entry.id);
                    actionsCell.appendChild(deleteButton);
                });
            } else {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 9; // زيادة عدد الأعمدة ليتناسب مع عمود الإجراءات
                cell.textContent = 'لا توجد قيود يومية للصندوق لهذا التاريخ/الفرع/النوع المحدد.';
                cell.style.textAlign = 'center';
                cell.style.color = '#777';
            }
            // بعد تحميل القيود، قم بحساب وعرض أرصدة الصندوق اليومية
            calculateAndDisplayDailyBalances(date, branchId);
        }

        // دالة لتعديل قيد يومية الصندوق
        function editCashJournalEntry(id) {
            const entries = getData('cashJournalEntries');
            const entryToEdit = entries.find(entry => entry.id === id);

            if (entryToEdit) {
                const cjEntryId = document.getElementById('cj_entry_id');
                if (cjEntryId) cjEntryId.value = entryToEdit.id;
                const cjBranch = document.getElementById('cj_branch');
                if (cjBranch) cjBranch.value = entryToEdit.branch_id;
                const cjDate = document.getElementById('cj_date');
                if (cjDate) cjDate.value = entryToEdit.entry_date;
                const cjDescription = document.getElementById('cj_description');
                if (cjDescription) cjDescription.value = entryToEdit.description;
                const cjType = document.getElementById('cj_type');
                if (cjType) cjType.value = entryToEdit.transaction_type;
                const cjAmount = document.getElementById('cj_amount');
                if (cjAmount) cjAmount.value = parseFloat(entryToEdit.amount);
                const cjPaymentMethod = document.getElementById('cj_payment_method');
                if (cjPaymentMethod) cjPaymentMethod.value = entryToEdit.payment_method;
                const cjNotes = document.getElementById('cj_notes');
                if (cjNotes) cjNotes.value = entryToEdit.notes;

                // إظهار/إخفاء حقل رقم المرجع بناءً على طريقة الدفع
                const checkNumberGroup = document.getElementById('checkNumberGroup');
                const cjCheckNumber = document.getElementById('cj_check_number');
                if (checkNumberGroup && cjCheckNumber) {
                    if (entryToEdit.payment_method === 'شبكة') {
                        checkNumberGroup.style.display = 'block';
                        cjCheckNumber.value = entryToEdit.check_number || '';
                        cjCheckNumber.setAttribute('required', 'required');
                    } else {
                        checkNumberGroup.style.display = 'none';
                        cjCheckNumber.value = '';
                        cjCheckNumber.removeAttribute('required');
                    }
                }

                // تغيير نص الزر وفئته لوضع التحديث
                const submitButton = document.getElementById('cj_submit_button');
                if (submitButton) {
                    submitButton.textContent = 'تحديث القيد';
                    submitButton.classList.add('update-mode');
                }

                // التمرير لأعلى الصفحة لسهولة التعديل
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                showMessage('cashJournalMessage', 'error', 'لم يتم العثور على القيد المطلوب تعديله.');
            }
        }

        // دالة لحذف قيد يومية الصندوق
        function deleteCashJournalEntry(id) {
            if (confirm('هل أنت متأكد أنك تريد حذف هذا القيد؟')) {
                let entries = getData('cashJournalEntries');
                const initialLength = entries.length;
                entries = entries.filter(entry => entry.id !== id);
                
                if (entries.length < initialLength) {
                    saveData('cashJournalEntries', entries);
                    showMessage('cashJournalMessage', 'success', 'تم حذف القيد بنجاح.');
                    loadCashJournalEntries(); // إعادة تحميل الجدول بعد الحذف وتحديث الملخص
                    const today = new Date().toISOString().split('T')[0];
                    calculateAndDisplayDailyBalances(today, null, 'mainPage'); // تحديث ملخص الصفحة الرئيسية
                } else {
                    showMessage('cashJournalMessage', 'error', 'خطأ: لم يتم العثور على القيد للحذف.');
                }
            }
        }


        // تحميل قيود الجرد وعرضها في الجدول
        function loadInventoryEntries() {
            const date = document.getElementById('view_inv_date')?.value;
            const branchId = document.getElementById('view_inv_branch')?.value;
            const allEntries = getData('inventoryEntries');
            let filteredEntries = allEntries.filter(entry => {
                return (entry.inventory_date === date) && 
                       (branchId === '' || entry.branch_id === branchId);
            });

            // فرز القيود تنازليًا حسب التاريخ ثم حسب معرف القيد (للحفاظ على ترتيب الإدخال)
            filteredEntries.sort((a, b) => {
                if (a.inventory_date !== b.inventory_date) {
                    return b.inventory_date.localeCompare(a.inventory_date);
                }
                return parseInt(b.id.split('_')[1]) - parseInt(a.id.split('_')[1]);
            });

            const tableBody = document.getElementById('inventoryEntriesBody');
            if (tableBody) {
                tableBody.innerHTML = ''; // مسح القيود الحالية
            }

            if (filteredEntries.length > 0) {
                filteredEntries.forEach(entry => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = entry.inventory_date;
                    row.insertCell().textContent = entry.branch_name;
                    row.insertCell().textContent = entry.item_description;
                    row.insertCell().textContent = entry.initial_quantity;
                    row.insertCell().textContent = entry.sales_quantity;
                    row.insertCell().textContent = entry.returns_quantity;
                    row.insertCell().textContent = entry.final_quantity;
                    row.insertCell().textContent = parseFloat(entry.unit_price).toFixed(2);
                    row.insertCell().textContent = parseFloat(entry.total_value).toFixed(2);
                    row.insertCell().textContent = entry.notes || '-';

                    // إضافة أزرار الإجراءات
                    const actionsCell = row.insertCell();
                    actionsCell.classList.add('action-buttons');
                    const editButton = document.createElement('button');
                    editButton.textContent = 'تعديل';
                    editButton.classList.add('edit-btn');
                    editButton.onclick = () => editInventoryEntry(entry.id);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'حذف';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.onclick = () => deleteInventoryEntry(entry.id);
                    actionsCell.appendChild(deleteButton);
                });
            } else {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 11; // زيادة عدد الأعمدة ليتناسب مع عمود الإجراءات
                cell.textContent = 'لا توجد قيود جرد لهذا التاريخ/الفرع المحدد.';
                cell.style.textAlign = 'center';
                cell.style.color = '#777';
            }
        }

        // دالة لتعديل قيد الجرد
        function editInventoryEntry(id) {
            const entries = getData('inventoryEntries');
            const entryToEdit = entries.find(entry => entry.id === id);

            if (entryToEdit) {
                const invEntryId = document.getElementById('inv_entry_id');
                if (invEntryId) invEntryId.value = entryToEdit.id;
                const invBranch = document.getElementById('inv_branch');
                if (invBranch) invBranch.value = entryToEdit.branch_id;
                const invDate = document.getElementById('inv_date');
                if (invDate) invDate.value = entryToEdit.inventory_date;
                const invItemDesc = document.getElementById('inv_item_desc');
                if (invItemDesc) invItemDesc.value = entryToEdit.item_description;
                const invInitialQty = document.getElementById('inv_initial_qty');
                if (invInitialQty) invInitialQty.value = entryToEdit.initial_quantity;
                const invSalesQty = document.getElementById('inv_sales_qty');
                if (invSalesQty) invSalesQty.value = entryToEdit.sales_quantity;
                const invReturnsQty = document.getElementById('inv_returns_qty');
                if (invReturnsQty) invReturnsQty.value = entryToEdit.returns_quantity;
                const invUnitPrice = document.getElementById('inv_unit_price');
                if (invUnitPrice) invUnitPrice.value = parseFloat(entryToEdit.unit_price);
                const invNotes = document.getElementById('inv_notes');
                if (invNotes) invNotes.value = entryToEdit.notes;

                // تغيير نص الزر وفئته لوضع التحديث
                const submitButton = document.getElementById('inv_submit_button');
                if (submitButton) {
                    submitButton.textContent = 'تحديث القيد';
                    submitButton.classList.add('update-mode');
                }

                // التمرير لأعلى الصفحة لسهولة التعديل
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                showMessage('inventoryMessage', 'error', 'لم يتم العثور على القيد المطلوب تعديله.');
            }
        }

        // دالة لحذف قيد الجرد
        function deleteInventoryEntry(id) {
            if (confirm('هل أنت متأكد أنك تريد حذف هذا القيد؟')) {
                let entries = getData('inventoryEntries');
                const initialLength = entries.length;
                entries = entries.filter(entry => entry.id !== id);
                
                if (entries.length < initialLength) {
                    saveData('inventoryEntries', entries);
                    showMessage('inventoryMessage', 'success', 'تم حذف القيد بنجاح.');
                    loadInventoryEntries(); // إعادة تحميل الجدول بعد الحذف
                } else {
                    showMessage('inventoryMessage', 'error', 'خطأ: لم يتم العثور على القيد للحذف.');
                }
            }
        }

        // توليد تقرير يومية الصندوق
        function generateCashJournalReport() {
            console.log('Generating Cash Journal Report...');
            const startDate = document.getElementById('report_start_date')?.value;
            const endDate = document.getElementById('report_end_date')?.value;
            const branchId = document.getElementById('report_branch')?.value;

            const allEntries = getData('cashJournalEntries');
            const reportEntries = allEntries.filter(entry => {
                return (entry.entry_date >= startDate && entry.entry_date <= endDate) &&
                       (branchId === '' || entry.branch_id === branchId);
            });
            console.log('Filtered cash journal entries count:', reportEntries.length);

            const tableBody = document.getElementById('cashJournalReportTable')?.querySelector('tbody');
            if (tableBody) {
                tableBody.innerHTML = '';
                console.log('Cash Journal Report Table body cleared.');
            } else {
                console.error('Cash Journal Report Table body not found!');
                return;
            }

            if (reportEntries.length > 0) {
                reportEntries.forEach(entry => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = entry.entry_date;
                    row.insertCell().textContent = entry.branch_name;
                    row.insertCell().textContent = entry.description;
                    row.insertCell().textContent = entry.transaction_type;
                    row.insertCell().textContent = parseFloat(entry.amount).toFixed(2);
                    row.insertCell().textContent = entry.payment_method;
                    row.insertCell().textContent = entry.check_number || '-';

                    // إضافة أزرار الإجراءات للتقرير
                    const actionsCell = row.insertCell();
                    actionsCell.classList.add('action-buttons');
                    const editButton = document.createElement('button');
                    editButton.textContent = 'تعديل';
                    editButton.classList.add('edit-btn');
                    editButton.onclick = () => editCashJournalEntryFromReport(entry.id);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'حذف';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.onclick = () => deleteCashJournalEntryFromReport(entry.id);
                    actionsCell.appendChild(deleteButton);
                });
                console.log('Cash Journal Report Table populated with data.');
            } else {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 8; // زيادة عدد الأعمدة ليتناسب مع عمود الإجراءات
                cell.textContent = 'لا توجد بيانات لهذا التقرير.';
                cell.style.textAlign = 'center';
                cell.style.color = '#777';
                console.log('No data for Cash Journal Report.');
            }
        }

        // دالة لتعديل قيد يومية الصندوق من صفحة التقرير
        function editCashJournalEntryFromReport(id) {
            showTab('cashJournal'); // الانتقال إلى تبويب يوميات الصندوق
            editCashJournalEntry(id); // استدعاء دالة التعديل الموجودة
        }

        // دالة لحذف قيد يومية الصندوق من صفحة التقرير
        function deleteCashJournalEntryFromReport(id) {
            deleteCashJournalEntry(id); // استدعاء دالة الحذف الموجودة
            // بعد الحذف، قد تحتاج إلى إعادة تحميل التقرير ليعكس التغيير
            generateCashJournalReport();
        }

        // توليد تقرير الجرد
        function generateInventoryReport() {
            console.log('Generating Inventory Report...');
            const startDate = document.getElementById('report_start_date')?.value;
            const endDate = document.getElementById('report_end_date')?.value;
            const branchId = document.getElementById('report_branch')?.value;

            const allEntries = getData('inventoryEntries');
            const reportEntries = allEntries.filter(entry => {
                return (entry.inventory_date >= startDate && entry.inventory_date <= endDate) &&
                       (branchId === '' || entry.branch_id === branchId);
            });
            console.log('Filtered inventory entries count:', reportEntries.length);

            const tableBody = document.getElementById('inventoryReportTable')?.querySelector('tbody');
            if (tableBody) {
                tableBody.innerHTML = '';
                console.log('Inventory Report Table body cleared.');
            } else {
                console.error('Inventory Report Table body not found!');
                return;
            }

            if (reportEntries.length > 0) {
                reportEntries.forEach(entry => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = entry.inventory_date;
                    row.insertCell().textContent = entry.branch_name;
                    row.insertCell().textContent = entry.item_description;
                    row.insertCell().textContent = entry.initial_quantity;
                    row.insertCell().textContent = entry.sales_quantity;
                    row.insertCell().textContent = entry.returns_quantity;
                    row.insertCell().textContent = entry.final_quantity;
                    row.insertCell().textContent = parseFloat(entry.unit_price).toFixed(2);
                    row.insertCell().textContent = parseFloat(entry.total_value).toFixed(2);

                    // إضافة أزرار الإجراءات للتقرير
                    const actionsCell = row.insertCell();
                    actionsCell.classList.add('action-buttons');
                    const editButton = document.createElement('button');
                    editButton.textContent = 'تعديل';
                    editButton.classList.add('edit-btn');
                    editButton.onclick = () => editInventoryEntryFromReport(entry.id);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'حذف';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.onclick = () => deleteInventoryEntryFromReport(entry.id);
                    actionsCell.appendChild(deleteButton);
                });
                console.log('Inventory Report Table populated with data.');
            } else {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 10; // زيادة عدد الأعمدة ليتناسب مع عمود الإجراءات
                cell.textContent = 'لا توجد بيانات لهذا التقرير.';
                cell.style.textAlign = 'center';
                cell.style.color = '#777';
                console.log('No data for Inventory Report.');
            }
        }

        // دالة لتعديل قيد الجرد من صفحة التقرير
        function editInventoryEntryFromReport(id) {
            showTab('inventory'); // الانتقال إلى تبويب الجرد اليومي
            editInventoryEntry(id); // استدعاء دالة التعديل الموجودة
        }

        // دالة لحذف قيد الجرد من صفحة التقرير
        function deleteInventoryEntryFromReport(id) {
            deleteInventoryEntry(id); // استدعاء دالة الحذف الموجودة
            // بعد الحذف، قد تحتاج إلى إعادة تحميل التقرير ليعكس التغيير
            generateInventoryReport();
        }

        // دالة الطباعة
        function printReport(target = 'all') { // Default to 'all' for printing both reports
            console.log('Initiating print for target:', target);

            // Elements to hide (general UI elements)
            const elementsToHide = document.querySelectorAll(
                '.app-header, .page-section:not(#cashJournalAppContainer):not(#mainPage), .tab-buttons, .form-group, button:not(.print-button):not(.back-button), .message, .add-from-report-buttons'
            );
            const originalDisplays = new Map();

            elementsToHide.forEach(el => {
                originalDisplays.set(el, el.style.display);
                el.style.display = 'none';
            });
            console.log('General UI elements hidden for printing.');

            // Ensure the main app container and reports tab are visible
            const appContainer = document.getElementById('cashJournalAppContainer');
            if (appContainer) {
                appContainer.style.display = 'block';
                console.log('Showing cashJournalAppContainer.');
            }
            const reportsTab = document.getElementById('reports');
            if (reportsTab) {
                reportsTab.style.display = 'block';
                console.log('Showing reports tab.');
            }

            const cashJournalReportCard = document.getElementById('cashJournalReportCard');
            const inventoryReportCard = document.getElementById('inventoryReportCard');

            // Store original display for report cards and hide them by default
            if (cashJournalReportCard) {
                originalDisplays.set(cashJournalReportCard, cashJournalReportCard.style.display);
                cashJournalReportCard.style.display = 'none';
            }
            if (inventoryReportCard) {
                originalDisplays.set(inventoryReportCard, inventoryReportCard.style.display);
                inventoryReportCard.style.display = 'none';
            }
            console.log('Report cards initially hidden.');

            if (target === 'all') {
                if (cashJournalReportCard) {
                    cashJournalReportCard.style.display = 'block';
                    console.log('Showing cashJournalReportCard for all print.');
                }
                if (inventoryReportCard) {
                    inventoryReportCard.style.display = 'block';
                    console.log('Showing inventoryReportCard for all print.');
                }
            } else { // Single table print
                const targetTable = document.getElementById(target);
                let parentCardToPrint = null;
                if (targetTable) {
                    parentCardToPrint = targetTable.closest('.card');
                    if (parentCardToPrint) {
                        parentCardToPrint.style.display = 'block';
                        console.log('Showing specific parent card for printing:', parentCardToPrint.id);
                    } else {
                        console.error('Parent card for table not found:', target);
                    }
                } else {
                    console.error('Target table for printing not found:', target);
                }
            }

            // Delay print slightly to ensure DOM updates are rendered
            setTimeout(() => {
                window.print();
                console.log('Print dialog opened.');

                // Restore original display states after printing
                originalDisplays.forEach((display, el) => {
                    el.style.display = display;
                });
                console.log('UI restored after printing.');

                // Ensure the currently active page section is visible again
                const activePageSection = document.querySelector('.page-section.active');
                if (activePageSection) {
                    activePageSection.style.display = 'block';
                    console.log('Restoring activePageSection:', activePageSection.id);
                } else {
                    showPage('mainPage'); // Fallback
                    console.log('No active page section, falling back to mainPage.');
                }
            }, 50); // Small delay
        }

        function addCashJournalFromReport() {
            const reportDate = document.getElementById('report_start_date')?.value;
            const reportBranchId = document.getElementById('report_branch')?.value;

            showPage('cashJournalAppContainer'); // التبديل إلى قسم يوميات الصندوق
            showTab('cashJournal'); // التبديل إلى تبويب يوميات الصندوق

            // إعادة تعيين النموذج لوضع الإضافة
            const cashJournalForm = document.getElementById('cashJournalForm');
            if (cashJournalForm) {
                cashJournalForm.reset();
            }
            const cjEntryId = document.getElementById('cj_entry_id');
            if (cjEntryId) cjEntryId.value = '';
            const cjSubmitButton = document.getElementById('cj_submit_button');
            if (cjSubmitButton) {
                cjSubmitButton.textContent = 'إضافة قيد';
                cjSubmitButton.classList.remove('update-mode');
            }
            const checkNumberGroup = document.getElementById('checkNumberGroup');
            if (checkNumberGroup) checkNumberGroup.style.display = 'none'; // إخفاء حقل رقم المرجع افتراضيًا
            const cjCheckNumber = document.getElementById('cj_check_number');
            if (cjCheckNumber) cjCheckNumber.removeAttribute('required');


            // ملء حقول التاريخ والفرع إذا كانت محددة في التقرير
            const cjDate = document.getElementById('cj_date');
            if (cjDate && reportDate) {
                cjDate.value = reportDate;
            }
            const cjBranch = document.getElementById('cj_branch');
            if (cjBranch && reportBranchId) {
                cjBranch.value = reportBranchId;
            }
            // التمرير لأعلى الصفحة لسهولة الإدخال
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // دالة للانتقال إلى تبويب الجرد وملء النموذج
        function addInventoryFromReport() {
            const reportDate = document.getElementById('report_start_date')?.value;
            const reportBranchId = document.getElementById('report_branch')?.value;

            showPage('cashJournalAppContainer'); // التبديل إلى قسم يوميات الصندوق
            showTab('inventory'); // التبديل إلى تبويب الجرد

            // إعادة تعيين النموذج لوضع الإضافة
            const inventoryForm = document.getElementById('inventoryForm');
            if (inventoryForm) {
                inventoryForm.reset();
            }
            const invEntryId = document.getElementById('inv_entry_id');
            if (invEntryId) invEntryId.value = '';
            const invSubmitButton = document.getElementById('inv_submit_button');
            if (invSubmitButton) {
                invSubmitButton.textContent = 'إضافة قيد جرد';
                invSubmitButton.classList.remove('update-mode');
            }

            // ملء حقول التاريخ والفرع إذا كانت محددة في التقرير
            const invDate = document.getElementById('inv_date');
            if (invDate && reportDate) {
                invDate.value = reportDate;
            }
            const invBranch = document.getElementById('inv_branch');
            if (invBranch && reportBranchId) {
                invBranch.value = reportBranchId;
            }
            // التمرير لأعلى الصفحة لسهولة الإدخال
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Sales Cashier Functions
        function addItemToCart() {
            const itemNameInput = document.getElementById('sale_item_name');
            const quantityInput = document.getElementById('sale_quantity');
            const unitPriceInput = document.getElementById('sale_unit_price');

            const itemName = itemNameInput?.value;
            const quantity = parseInt(quantityInput?.value);
            const unitPrice = parseFloat(unitPriceInput?.value);

            console.log('Adding item:', { itemName, quantity, unitPrice }); // Debugging log

            if (!itemName || isNaN(quantity) || quantity <= 0 || isNaN(unitPrice) || unitPrice < 0) {
                showMessage('salesMessage', 'error', 'الرجاء إدخال بيانات صنف صحيحة (اسم، كمية، سعر).');
                return;
            }

            const existingItemIndex = salesCart.findIndex(item => item.itemName === itemName);

            if (existingItemIndex !== -1) {
                // If item exists, update quantity and total
                salesCart[existingItemIndex].quantity += quantity;
                salesCart[existingItemIndex].totalPrice = (salesCart[existingItemIndex].quantity * salesCart[existingItemIndex].unitPrice).toFixed(2);
                showMessage('salesMessage', 'success', `تم تحديث كمية الصنف "${itemName}".`);
            } else {
                // Add new item to cart
                salesCart.push({
                    itemName: itemName,
                    quantity: quantity,
                    unitPrice: unitPrice,
                    totalPrice: (quantity * unitPrice).toFixed(2)
                });
                showMessage('salesMessage', 'success', `تم إضافة الصنف "${itemName}" إلى السلة.`);
            }

            console.log('Current salesCart:', salesCart); // Debugging log
            updateCartDisplay();
            // Clear input fields after adding
            if (itemNameInput) itemNameInput.value = '';
            if (quantityInput) quantityInput.value = '1';
            if (unitPriceInput) unitPriceInput.value = '0.00';
        }

        function removeItemFromCart(index) {
            if (index > -1 && index < salesCart.length) {
                const removedItemName = salesCart[index].itemName;
                salesCart.splice(index, 1);
                showMessage('salesMessage', 'success', `تم حذف الصنف "${removedItemName}" من السلة.`);
                updateCartDisplay();
            }
        }

        function updateCartDisplay() {
            const salesCartBody = document.getElementById('salesCartBody');
            const cartTotalElement = document.getElementById('cartTotal');
            let totalCartAmount = 0;

            if (salesCartBody) {
                salesCartBody.innerHTML = ''; // Clear current display
                salesCart.forEach((item, index) => {
                    const row = salesCartBody.insertRow();
                    row.insertCell().textContent = item.itemName;
                    row.insertCell().textContent = item.quantity;
                    row.insertCell().textContent = parseFloat(item.unitPrice).toFixed(2);
                    row.insertCell().textContent = parseFloat(item.totalPrice).toFixed(2);
                    
                    totalCartAmount += parseFloat(item.totalPrice);

                    const actionsCell = row.insertCell();
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'حذف';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.style.width = 'auto'; // Override 100% width
                    deleteButton.style.padding = '5px 10px';
                    deleteButton.style.fontSize = '14px';
                    deleteButton.onclick = () => removeItemFromCart(index);
                    actionsCell.appendChild(deleteButton);
                });
            }

            if (cartTotalElement) {
                cartTotalElement.textContent = totalCartAmount.toFixed(2);
            }
            console.log('Cart display updated. Total:', totalCartAmount.toFixed(2)); // Debugging log
            updatePaymentDetails(); // Update payment details whenever cart changes
        }

        function updatePaymentDetails() {
            const cartTotal = parseFloat(document.getElementById('cartTotal')?.textContent) || 0;
            const paymentMethodSelect = document.getElementById('sale_payment_method');
            const amountPaidInput = document.getElementById('sale_amount_paid');
            const saleChangeElement = document.getElementById('saleChange');
            const saleAmountPaidGroup = document.getElementById('saleAmountPaidGroup');

            if (!paymentMethodSelect || !amountPaidInput || !saleChangeElement || !saleAmountPaidGroup) return;

            const paymentMethod = paymentMethodSelect.value;

            if (paymentMethod === 'نقدي') {
                saleAmountPaidGroup.style.display = 'block';
                const amountPaid = parseFloat(amountPaidInput.value) || 0;
                const change = amountPaid - cartTotal;
                saleChangeElement.textContent = change.toFixed(2);
            } else {
                saleAmountPaidGroup.style.display = 'none';
                amountPaidInput.value = cartTotal.toFixed(2); // For network, assume full amount paid
                saleChangeElement.textContent = '0.00'; // No change for network
            }
        }

        function completeSale() {
            console.log('completeSale function called.'); // Debugging log
            if (salesCart.length === 0) {
                showMessage('salesMessage', 'error', 'السلة فارغة. الرجاء إضافة أصناف قبل إتمام البيع.');
                console.log('Sales cart is empty. Sale aborted.'); // Debugging log
                return;
            }

            const cartTotal = parseFloat(document.getElementById('cartTotal')?.textContent) || 0;
            const paymentMethod = document.getElementById('sale_payment_method')?.value;
            const amountPaid = parseFloat(document.getElementById('sale_amount_paid')?.value) || 0;
            const change = parseFloat(document.getElementById('saleChange')?.textContent) || 0;

            console.log('Sale details:', { cartTotal, paymentMethod, amountPaid, change }); // Debugging log

            if (paymentMethod === 'نقدي' && amountPaid < cartTotal) {
                showMessage('salesMessage', 'error', 'المبلغ المدفوع أقل من إجمالي السلة.');
                console.log('Amount paid is less than cart total. Sale aborted.'); // Debugging log
                return;
            }

            let salesEntries = getData('salesEntries');
            const newSale = {
                id: 'sale_' + Date.now(),
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }),
                items: salesCart,
                totalAmount: cartTotal.toFixed(2),
                paymentMethod: paymentMethod,
                amountPaid: amountPaid.toFixed(2),
                change: change.toFixed(2)
            };
            salesEntries.push(newSale);
            saveData('salesEntries', salesEntries);
            console.log('Sale recorded:', newSale); // Debugging log

            // إضافة قيد يومية للصندوق بناءً على عملية البيع
            const today = new Date().toISOString().split('T')[0];
            
            // تحقق من وجود فروع قبل محاولة الحصول على الفرع الحالي
            if (branches.length > 0) {
                // افتراض الفرع الأول إذا لم يكن هناك حقل اختيار الفرع في واجهة الكاشير
                const currentBranch = branches[0].id; 
                const selectedBranch = branches.find(b => b.id === currentBranch);

                if (selectedBranch) {
                    const cashJournalEntry = {
                        id: 'cj_' + Date.now() + '_sale',
                        branch_id: selectedBranch.id,
                        branch_name: selectedBranch.name,
                        entry_date: today,
                        description: `مبيعات اليوم - فاتورة رقم ${newSale.id.split('_')[1]}`,
                        transaction_type: `إيراد ${paymentMethod === 'نقدي' ? 'نقدي' : 'شبكة'}`,
                        amount: cartTotal.toFixed(2),
                        payment_method: paymentMethod,
                        check_number: paymentMethod === 'شبكة' ? 'مرجع بيع' : '', // يمكن إضافة مرجع حقيقي هنا
                        notes: 'قيد آلي من واجهة الكاشير'
                    };
                    let cjEntries = getData('cashJournalEntries');
                    cjEntries.push(cashJournalEntry);
                    saveData('cashJournalEntries', cjEntries);
                    console.log('Cash Journal Entry added:', cashJournalEntry); // Debugging log
                    calculateAndDisplayDailyBalances(today, null, 'mainPage'); // تحديث ملخص الصفحة الرئيسية بعد إضافة قيد الصندوق
                } else {
                    console.warn('Selected branch not found for cash journal entry. Branch ID:', currentBranch); // Debugging log
                    showMessage('salesMessage', 'warning', 'تم إتمام البيع ولكن لم يتم تسجيل قيد يومية الصندوق بسبب عدم توفر الفرع المحدد.');
                }
            } else {
                console.warn('No branches available to create cash journal entry.'); // Debugging log
                showMessage('salesMessage', 'warning', 'تم إتمام البيع ولكن لم يتم تسجيل قيد يومية الصندوق بسبب عدم وجود فروع معرفة. الرجاء إضافة فروع من "إدارة الفروع".');
            }

            showMessage('salesMessage', 'success', `تم إتمام البيع بنجاح! الإجمالي: ${cartTotal.toFixed(2)}، المدفوع: ${amountPaid.toFixed(2)}، الباقي: ${change.toFixed(2)}.`);
            clearCart(); // Clear the cart after successful sale
        }

        function clearCart() {
            salesCart = [];
            const itemNameInput = document.getElementById('sale_item_name');
            if (itemNameInput) itemNameInput.value = '';
            const quantityInput = document.getElementById('sale_quantity');
            if (quantityInput) quantityInput.value = '1';
            const unitPriceInput = document.getElementById('sale_unit_price');
            if (unitPriceInput) unitPriceInput.value = '0.00';
            const paymentMethodSelect = document.getElementById('sale_payment_method');
            if (paymentMethodSelect) paymentMethodSelect.value = 'نقدي';
            const amountPaidInput = document.getElementById('sale_amount_paid');
            if (amountPaidInput) amountPaidInput.value = '0.00';
            updateCartDisplay();
            updatePaymentDetails(); // Reset payment details
        }
    </script>
</body>
</html>
